<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
    <meta charset="utf-8">
    <title>Static Music Library | Wenxing Duan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A static, metadata-driven music player for albums in the Music folder.">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="shortcut icon" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        referrerpolicy="no-referrer">
    <link rel="stylesheet" href="css/fonts.css">
    <link rel="stylesheet" href="css/default.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/media-queries.css">
    <style>
        :root {
            color-scheme: light dark;
            --accent: #1dd4d4;
            --panel: rgba(10, 18, 28, 0.9);
            --panel-2: rgba(16, 26, 40, 0.85);
            --ink: #f8f9fb;
            --muted: rgba(248, 249, 251, 0.75);
            --bg: radial-gradient(circle at 25% 20%, #1a2a38, #070c14 60%);
            --card-shadow: 0 26px 70px rgba(0, 0, 0, 0.45);
            --track-bg: transparent;
            --track-bg-active: rgba(29, 212, 212, 0.14);
            --track-border: rgba(255, 255, 255, 0.06);
            --track-border-active: rgba(29, 212, 212, 0.5);
            --surface-contrast: #1c2035;
        }

        :root[data-theme="light"] {
            color-scheme: light;
            --panel: rgba(255, 255, 255, 0.95);
            --panel-2: rgba(243, 247, 251, 0.96);
            --ink: #0b1320;
            --muted: rgba(12, 15, 26, 0.65);
            --bg: radial-gradient(circle at 20% 20%, #f4fbff, #e4f2f6 60%);
            --card-shadow: 0 18px 50px rgba(0, 0, 0, 0.12);
            --track-bg: transparent;
            --track-bg-active: rgba(29, 212, 212, 0.16);
            --track-border: rgba(0, 0, 0, 0.08);
            --track-border-active: rgba(29, 212, 212, 0.55);
            --surface-contrast: #e7f2f6;
        }

        body {
            min-height: 100vh;
            margin: 0;
            font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg);
            color: var(--ink);
            display: flex;
            justify-content: center;
            padding: 2.5rem 1rem 4rem;
            transition: background 0.25s ease, color 0.25s ease;
        }

        main {
            width: min(1100px, 100%);
            background: linear-gradient(145deg, var(--panel), var(--panel));
            border-radius: 22px;
            padding: clamp(1.25rem, 3vw, 2.5rem);
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(18px);
            transition: background 0.25s ease, box-shadow 0.25s ease;
        }

        /* Override global header background from layout.css so header-background.jpg is not used on this page */
        header.page-header {
            background: none !important;
            height: auto;
            min-height: 0;
            padding: 0;
        }

        header.page-header:before {
            display: none;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .page-header h1 {
            margin: 0.2rem 0;
            font-size: clamp(2rem, 4vw, 2.8rem);
            letter-spacing: 0.02em;
            color: var(--ink);
        }

        .page-header p {
            margin: 0.2rem 0;
            color: var(--muted);
        }

        .theme-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.55rem 0.85rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: var(--panel-2);
            color: var(--ink);
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.12s ease, border-color 0.2s ease, background 0.2s ease;
        }

        :root[data-theme="light"] .theme-toggle {
            border-color: rgba(0, 0, 0, 0.08);
        }

        .theme-toggle:hover {
            transform: translateY(-1px);
            border-color: rgba(255, 255, 255, 0.25);
        }

        :root[data-theme="light"] .theme-toggle:hover {
            border-color: rgba(0, 0, 0, 0.15);
        }

        .section-heading {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 0.75rem;
            gap: 1rem;
        }

        .section-heading h2 {
            margin: 0;
            font-size: 1.2rem;
            letter-spacing: 0.02em;
        }

        .pill {
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--muted);
            font-size: 0.85rem;
        }

        .album-section {
            background: var(--panel);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1.25rem;
        }

        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 0.8rem;
        }

        .album-card {
            border: 1px solid var(--track-border);
            background: var(--panel-2);
            border-radius: 16px;
            padding: 0.75rem;
            color: inherit;
            text-align: left;
            cursor: pointer;
            transition: transform 0.15s ease, border-color 0.15s ease, background 0.2s ease;
        }

        .album-card:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .album-card:hover {
            transform: translateY(-2px);
            border-color: var(--track-border-active);
        }

        .album-card.active {
            border-color: var(--accent);
            box-shadow: 0 10px 30px rgba(29, 212, 212, 0.25);
        }

        .cover-wrap {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(29, 212, 212, 0.35), rgba(17, 28, 42, 0.9));
            margin-bottom: 0.6rem;
        }

        .cover-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .cover-fallback {
            width: 100%;
            height: 100%;
            display: grid;
            place-items: center;
            font-weight: 700;
            font-size: 1.6rem;
            color: #0b0d17;
            background: linear-gradient(140deg, #fbd786, #f7797d);
        }

        .album-meta strong {
            display: block;
            margin-bottom: 0.15rem;
        }

        .album-meta span {
            display: block;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .album-meta small {
            color: rgba(248, 249, 251, 0.6);
        }

        .player-panel {
            background: var(--panel);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 1.5rem;
            align-items: stretch;
        }

        .cover-art {
            margin: 0;
            border-radius: 16px;
            overflow: hidden;
            background: #111527;
            min-height: 280px;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .cover-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .cover-placeholder {
            position: absolute;
            inset: 0;
            display: none;
            place-items: center;
            font-size: 3rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            background: linear-gradient(160deg, #6dd5ed, #2193b0);
            color: #0b0d17;
            pointer-events: none;
        }

        .cover-placeholder.show {
            display: grid;
        }

        .control-stack {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .now-playing {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .now-playing small {
            text-transform: uppercase;
            letter-spacing: 0.18rem;
            color: var(--muted);
        }

        .now-playing strong {
            font-size: 1.35rem;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .controls button {
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: var(--surface-contrast);
            color: var(--ink);
            padding: 0.85rem 1.1rem;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.15s ease;
        }

        .controls button:hover {
            background: rgba(29, 212, 212, 0.12);
            transform: translateY(-1px);
        }

        .controls button:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .play-toggle {
            background: var(--accent);
            border-color: rgba(255, 255, 255, 0.1);
            flex: 1;
        }

        .progress-row,
        .volume-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-row input[type="range"],
        .volume-row input[type="range"] {
            flex: 1;
        }

        input[type="range"] {
            accent-color: var(--accent);
        }

        .seek-label {
            min-width: 3rem;
            text-align: right;
            font-variant-numeric: tabular-nums;
            color: var(--muted);
        }

        .playlist {
            background: var(--panel);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 1rem;
            box-shadow: var(--card-shadow);
        }

        .playlist h2 {
            margin: 0 0 0.6rem;
            font-size: 1.1rem;
        }

        .playlist small {
            color: var(--muted);
        }

        .track-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .track-list li {
            margin: 0;
            padding: 0.12rem 0;
        }

        .track-btn {
            width: 100%;
            background: var(--track-bg);
            border: 1px solid var(--track-border);
            color: var(--ink);
            padding: 0.65rem 0.75rem;
            border-radius: 12px;
            display: grid;
            grid-template-columns: 60px 1fr 70px;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease;
            text-align: center;
        }

        .track-btn:hover,
        .track-btn:focus-visible {
            background: var(--track-bg-active);
            border-color: var(--track-border-active);
            outline: none;
        }

        .track-btn.active {
            background: var(--track-bg-active);
            border-color: var(--track-border-active);
            color: var(--ink);
        }

        .track-title {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
            justify-content: center;
            text-align: center;
        }

        .track-title strong {
            font-weight: 600;
            color: var(--ink);
        }

        .track-title small {
            color: var(--muted);
        }

        .track-number {
            min-width: 2.5rem;
            text-align: center;
            color: var(--muted);
            font-variant-numeric: tabular-nums;
        }

        @media (max-width: 840px) {
            .player-panel {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 1.25rem 0.6rem 2rem;
            }

            .album-card {
                padding: 0.65rem;
            }
        }
    </style>
</head>

<body>
    <main>
        <header class="page-header">
            <div>
                <h1>Silent Library</h1>
            </div>
            <button type="button" id="theme-toggle" class="theme-toggle" aria-label="Toggle light/dark mode">
                <i class="fa-solid fa-circle-half-stroke"></i>
                <span>Light</span>
            </button>
        </header>

        <section class="album-section" aria-label="Album selection">
            <div class="section-heading">
                <h2>Albums</h2>
                <span class="pill" id="album-count">Loading...</span>
            </div>
            <div class="album-grid" id="album-grid" role="list"></div>
        </section>

        <section class="player-panel" aria-label="Player controls">
            <figure class="cover-art">
                <img id="cover-img" src="" alt="Album artwork" hidden loading="lazy">
                <div id="cover-placeholder" class="cover-placeholder">*</div>
            </figure>

            <div class="control-stack">
                <div class="now-playing">
                    <small id="album-label">Select an album</small>
                    <strong id="current-track">Waiting for selection...</strong>
                    <span id="current-artist"></span>
                </div>

                <div class="controls">
                    <button type="button" id="prev-btn" aria-label="Previous track">
                        <i class="fa-solid fa-backward-step"></i>
                    </button>
                    <button type="button" class="play-toggle" id="play-toggle" aria-label="Play or pause">
                        <i class="fa-solid fa-play"></i>
                        <span>Play</span>
                    </button>
                    <button type="button" id="next-btn" aria-label="Next track">
                        <i class="fa-solid fa-forward-step"></i>
                    </button>
                </div>

                <div class="progress-row">
                    <span class="seek-label" id="current-time">00:00</span>
                    <input type="range" min="0" max="100" value="0" id="progress" aria-label="Playback progress">
                    <span class="seek-label" id="duration">00:00</span>
                </div>

                <div class="volume-row">
                    <i class="fa-solid fa-volume-high" aria-hidden="true"></i>
                    <input type="range" min="0" max="100" value="40" id="volume" aria-label="Volume">
                </div>
            </div>
        </section>

        <section class="playlist" aria-label="Playlist">
            <h2 id="playlist-title">Tracklist</h2>
            <small id="playlist-subtitle">Choose an album to load tracks.</small>
            <ol class="track-list" id="playlist"></ol>
        </section>
    </main>

    <audio id="audio" preload="metadata" aria-hidden="true"></audio>

    <script>
        const albumGrid = document.getElementById("album-grid");
        const albumCount = document.getElementById("album-count");
        const playlistElement = document.getElementById("playlist");
        const playlistTitle = document.getElementById("playlist-title");
        const playlistSubtitle = document.getElementById("playlist-subtitle");
        const coverImg = document.getElementById("cover-img");
        const coverPlaceholder = document.getElementById("cover-placeholder");
        const albumLabel = document.getElementById("album-label");
        const currentTrackEl = document.getElementById("current-track");
        const currentArtistEl = document.getElementById("current-artist");
        const currentTimeEl = document.getElementById("current-time");
        const durationEl = document.getElementById("duration");
        const progress = document.getElementById("progress");
        const volume = document.getElementById("volume");
        const playToggle = document.getElementById("play-toggle");
        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const audio = document.getElementById("audio");
        const themeToggle = document.getElementById("theme-toggle");

        let albums = [];
        let currentAlbumIndex = 0;
        let currentTrackIndex = 0;
        let isSeeking = false;

        function updatePlayVisual(isPlaying) {
            if (isPlaying) {
                playToggle.querySelector("i").className = "fa-solid fa-pause";
                playToggle.querySelector("span").textContent = "Pause";
            } else {
                playToggle.querySelector("i").className = "fa-solid fa-play";
                playToggle.querySelector("span").textContent = "Play";
            }
        }

        function pad(num) {
            return String(num).padStart(2, "0");
        }

        function formatTime(seconds) {
            if (!Number.isFinite(seconds)) return "00:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${pad(m)}:${pad(s)}`;
        }

        function placeholderText(name) {
            if (!name) return "*";
            const first = name.trim()[0];
            return first ? first.toUpperCase() : "*";
        }

        function resolveAlbumCover(albumIndex) {
            const album = albums[albumIndex];
            if (!album) return null;
            if (album.cover) {
                if (album.cover.startsWith("data:")) return album.cover;
                const normalized = album.cover.replace(/\\/g, "/");
                return normalized.startsWith("http")
                    ? normalized
                    : new URL(normalized, window.location.href).href;
            }
            // Fallback to thumbnail in album grid if available
            const card = document.querySelector(`.album-card[data-index="${albumIndex}"]`);
            const img = card ? card.querySelector("img") : null;
            if (img && img.src) return img.src;
            return null;
        }

        function setCover(albumIndex) {
            const album = albums[albumIndex];
            const coverSrc = resolveAlbumCover(albumIndex);
            if (!coverSrc) {
                coverImg.hidden = true;
                coverPlaceholder.classList.add("show");
                coverPlaceholder.textContent = placeholderText(album ? album.album : "");
                return;
            }

            coverImg.onerror = () => {
                coverImg.hidden = true;
                coverPlaceholder.classList.add("show");
                coverPlaceholder.textContent = placeholderText(album ? album.album : "");
            };
            coverImg.src = coverSrc;
            coverImg.hidden = false;
            coverPlaceholder.classList.remove("show");
        }

        function renderAlbumGrid() {
            albumGrid.innerHTML = "";
            albums.forEach((album, index) => {
                const card = document.createElement("button");
                card.className = "album-card";
                card.type = "button";
                card.dataset.index = index;

                const coverMarkup = album.cover
                    ? `<img src="${album.cover}" alt="${album.album} cover" loading="lazy">`
                    : `<div class="cover-fallback">${placeholderText(album.album)}</div>`;

                card.innerHTML = `
                    <div class="cover-wrap">${coverMarkup}</div>
                    <div class="album-meta">
                        <strong>${album.album}</strong>
                        <span>${album.albumArtist || "Unknown Artist"}</span>
                        <small>${album.tracks.length} tracks</small>
                    </div>
                `;
                albumGrid.appendChild(card);
            });
            albumCount.textContent = `${albums.length} albums`;
        }

        function renderPlaylist(album) {
            playlistElement.innerHTML = "";
            if (!album || !album.tracks.length) {
                playlistSubtitle.textContent = "No tracks found for this album.";
                return;
            }
            playlistSubtitle.textContent = `${album.tracks.length} tracks`;
            album.tracks.forEach((track, index) => {
                const item = document.createElement("li");
                const button = document.createElement("button");
                button.className = "track-btn";
                button.type = "button";
                button.dataset.index = index;
                const trackNumber = track.track ?? index + 1;
                button.innerHTML = `
                    <span class="track-number">${pad(trackNumber)}</span>
                    <span class="track-title">
                        <strong>${track.title}</strong>
                        <small>${track.artist || "Unknown Artist"}</small>
                    </span>
                    <span class="seek-label">${track.duration ? formatTime(track.duration) : ""}</span>
                `;
                item.appendChild(button);
                playlistElement.appendChild(item);
            });
        }

        function markActiveTrack(index) {
            document.querySelectorAll(".track-btn").forEach((btn) => {
                btn.classList.toggle("active", Number(btn.dataset.index) === index);
            });
        }

        function markActiveAlbum() {
            document.querySelectorAll(".album-card").forEach((card) => {
                card.classList.toggle("active", Number(card.dataset.index) === currentAlbumIndex);
            });
        }

        function setActiveTrack(index, autoplay = false) {
            const album = albums[currentAlbumIndex];
            if (!album || !album.tracks[index]) return;
            currentTrackIndex = index;
            const track = album.tracks[index];

            audio.src = encodeURI(track.src);
            currentTrackEl.textContent = track.title;
            currentArtistEl.textContent = track.artist || album.albumArtist || "";
            albumLabel.textContent = album.album;
            progress.value = 0;
            currentTimeEl.textContent = "00:00";
            durationEl.textContent = "00:00";
            markActiveTrack(index);
            setCover(currentAlbumIndex);
            if (!autoplay) {
                updatePlayVisual(false);
            }
            if (autoplay) {
                const playPromise = audio.play();
                if (playPromise instanceof Promise) {
                    playPromise.catch(() => { /* autoplay might be blocked */ updatePlayVisual(false); });
                }
            }
        }

        function selectAlbum(index, autoplay = false) {
            if (!albums[index]) return;
            currentAlbumIndex = index;
            markActiveAlbum();
            const album = albums[index];
            playlistTitle.textContent = album.album;
            playlistSubtitle.textContent = album.albumArtist || "";
            setCover(currentAlbumIndex);
            renderPlaylist(album);
            const shouldAutoplay = autoplay && album.tracks.length > 0;
            setActiveTrack(0, shouldAutoplay);
            if (!shouldAutoplay) {
                audio.pause();
                updatePlayVisual(false);
            }
        }

        function togglePlay() {
            if (!audio.src) {
                setActiveTrack(currentTrackIndex, true);
                return;
            }
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
            }
        }

        function playNext(direction = 1, allowAlbumAdvance = false) {
            const album = albums[currentAlbumIndex];
            if (!album || !album.tracks.length) return;
            const len = album.tracks.length;
            let newIndex = currentTrackIndex + direction;

            if (newIndex < 0) {
                if (allowAlbumAdvance && albums.length > 1) {
                    const prevAlbumIndex = (currentAlbumIndex - 1 + albums.length) % albums.length;
                    selectAlbum(prevAlbumIndex, false);
                    setActiveTrack(albums[prevAlbumIndex].tracks.length - 1, true);
                    return;
                }
                newIndex = len - 1;
            } else if (newIndex >= len) {
                if (allowAlbumAdvance && albums.length > 1) {
                    const nextAlbumIndex = (currentAlbumIndex + 1) % albums.length;
                    selectAlbum(nextAlbumIndex, false);
                    setActiveTrack(0, true);
                    return;
                }
                newIndex = 0;
            }

            const shouldAutoplay = allowAlbumAdvance || (!audio.paused && Boolean(audio.currentSrc));
            setActiveTrack(newIndex, shouldAutoplay);
        }

        function attachEvents() {
            playToggle.addEventListener("click", togglePlay);
            prevBtn.addEventListener("click", () => playNext(-1));
            nextBtn.addEventListener("click", () => playNext(1));

            themeToggle.addEventListener("click", () => {
                const current = document.documentElement.getAttribute("data-theme") || "dark";
                const next = current === "light" ? "dark" : "light";
                applyTheme(next);
            });

            albumGrid.addEventListener("click", (event) => {
                const card = event.target.closest(".album-card");
                if (!card) return;
                const index = Number(card.dataset.index);
                selectAlbum(index, false);
            });

            playlistElement.addEventListener("click", (event) => {
                const button = event.target.closest(".track-btn");
                if (!button) return;
                const index = Number(button.dataset.index);
                setActiveTrack(index, true);
            });

            audio.addEventListener("play", () => updatePlayVisual(true));

            audio.addEventListener("pause", () => updatePlayVisual(false));

        audio.addEventListener("timeupdate", () => {
            if (!audio.duration) return;
            currentTimeEl.textContent = formatTime(audio.currentTime);
            progress.value = (audio.currentTime / audio.duration) * 100;
        });

            audio.addEventListener("loadedmetadata", () => {
                durationEl.textContent = formatTime(audio.duration);
            });

            audio.addEventListener("ended", () => playNext(1, true));

        progress.addEventListener("input", () => {
            if (!audio.duration) return;
            const seekTime = (progress.value / 100) * audio.duration;
            audio.currentTime = seekTime;
            currentTimeEl.textContent = formatTime(seekTime);
        });

        progress.addEventListener("change", () => {
            if (!audio.duration) return;
            const seekTime = (progress.value / 100) * audio.duration;
            audio.currentTime = seekTime;
        });

            volume.addEventListener("input", () => {
                audio.volume = volume.value / 100;
            });
        }

        async function loadLibrary() {
            try {
                const url = new URL("music-library.json", window.location.href);
                const response = await fetch(url, { cache: "no-store" });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                const sortedAlbums = (data.albums || []).slice().sort((a, b) =>
                    a.album.localeCompare(b.album, "en", { sensitivity: "base" })
                );
                albums = sortedAlbums;
                renderAlbumGrid();
                if (albums.length) {
                    selectAlbum(0, false);
                } else {
                    albumCount.textContent = "0 albums";
                    playlistSubtitle.textContent = "No albums found in library.";
                }
            } catch (error) {
                albumCount.textContent = "Load failed";
                const tip = location.protocol === "file:" ? "Open via http:// (e.g. python -m http.server) so fetch can read JSON." : "";
                playlistSubtitle.textContent = `Failed to load library: ${error.message} ${tip}`;
            }
        }

        attachEvents();
        loadLibrary();
        audio.volume = volume.value / 100;

        function applyTheme(theme) {
            document.documentElement.setAttribute("data-theme", theme);
            localStorage.setItem("theme", theme);
            themeToggle.querySelector("span").textContent = theme === "light" ? "Dark" : "Light";
        }

        const storedTheme = localStorage.getItem("theme");
        applyTheme(storedTheme === "light" ? "light" : "dark");
    </script>
</body>

</html>
